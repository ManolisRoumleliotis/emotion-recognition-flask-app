<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <title>Emotion Recognition (Upload + Webcam + LLM)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; }
    .row { display: flex; gap: 24px; align-items: flex-start; flex-wrap: wrap; }
    .card { border: 1px solid #ddd; padding: 12px; width: 520px; }
    .wide { width: 1088px; }
    .box { border: 1px solid #ddd; padding: 10px; margin-top: 10px; }
    img { max-width: 100%; height: auto; display: block; margin-top: 10px; }
    textarea { width: 100%; min-height: 110px; }
    button { margin-top: 6px; }
    .muted { color:#666; font-size: 0.95em; }
    pre { background:#f7f7f7; padding:10px; overflow:auto; }
  </style>
</head>
<body>
  <h1>Emotion Recognition (Upload + Webcam + LLM)</h1>

  <div class="row">
    <!-- Upload -->
    <div class="card">
      <h2>1) Upload εικόνας</h2>
      <form action="/upload" method="post" enctype="multipart/form-data">
        <input type="file" name="file" />
        <button type="submit">Upload</button>
      </form>

      {% if result %}
        <div class="box">
          <b>AI Result:</b><br/>
          {{ result|safe }}
        </div>
      {% endif %}

      {% if filename %}
        <h3>Εικόνα με bounding boxes</h3>
        <img src="/uploads/{{ filename }}" alt="Annotated image" />
      {% endif %}
    </div>

    <!-- Webcam -->
    <div class="card">
      <h2>2) Webcam</h2>
      <div class="muted">Start webcam → Capture & Analyze (στέλνει frame στο Flask)</div>
      <div style="margin-top:8px;">
        <button id="startBtn">Start Webcam</button>
        <button id="stopBtn" disabled>Stop Webcam</button>
        <button id="capBtn" disabled>Capture & Analyze</button>
      </div>

      <video id="video" autoplay playsinline style="width:100%; margin-top:10px; border:1px solid #ddd;"></video>
      <canvas id="canvas" style="display:none;"></canvas>

      <div id="webcamOut" class="box" style="display:none;"></div>
      <div id="webcamImg"></div>
      <pre id="webcamJson" style="display:none;"></pre>
    </div>
  </div>

  <!-- LLM Prompt -->
  <div class="card wide" style="margin-top:24px;">
    <h2>3) LLM (Live) – Γράψε prompt</h2>
    <div class="muted">
      Το LLM χρησιμοποιεί LIVE τα τελευταία δεδομένα ανίχνευσης (upload ή webcam) και επιστρέφει περιγραφή.
    </div>

    <div class="box">
      <b>Τελευταία ανίχνευση:</b><br>
      <span class="muted">
        Πηγή: {{ last.context }} |
        Πρόσωπα: {{ last.faces_detected }} |
        Κυρίαρχο: {{ last.dominant }} |
        Χρόνος: {{ last.timestamp }}
      </span>
    </div>

    <textarea id="promptTxt" placeholder="π.χ. Γράψε μια σύντομη, αντικειμενική περιγραφή με βάση το συναίσθημα και το confidence."></textarea>
    <button id="llmBtn">Send to LLM</button>

    <div id="llmOut" class="box" style="display:none;"></div>
  </div>

  <!-- Charts -->
  <h2 style="margin-top:24px;">Emotion Distribution Visualizations</h2>

  {% if bar_chart %}
    <h3>Bar</h3>
    <img src="{{ url_for('static', filename=bar_chart) }}" alt="Bar chart" />
  {% endif %}

  {% if line_chart %}
    <h3>Line</h3>
    <img src="{{ url_for('static', filename=line_chart) }}" alt="Line chart" />
  {% endif %}

  {% if pie_chart %}
    <h3>Pie</h3>
    <img src="{{ url_for('static', filename=pie_chart) }}" alt="Pie chart" />
  {% endif %}

<script>
  const startBtn = document.getElementById("startBtn");
  const stopBtn  = document.getElementById("stopBtn");
  const capBtn   = document.getElementById("capBtn");
  const video    = document.getElementById("video");
  const canvas   = document.getElementById("canvas");
  const webcamOut= document.getElementById("webcamOut");
  const webcamImg= document.getElementById("webcamImg");
  const webcamJson= document.getElementById("webcamJson");

  let stream = null;

  startBtn.onclick = async () => {
    stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
    video.srcObject = stream;
    stopBtn.disabled = false;
    capBtn.disabled = false;
    startBtn.disabled = true;
  };

  stopBtn.onclick = () => {
    if (stream) stream.getTracks().forEach(t => t.stop());
    stream = null;
    video.srcObject = null;
    stopBtn.disabled = true;
    capBtn.disabled = true;
    startBtn.disabled = false;
  };

  capBtn.onclick = async () => {
    const w = video.videoWidth;
    const h = video.videoHeight;
    if (!w || !h) return;

    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, w, h);
    const dataUrl = canvas.toDataURL("image/jpeg", 0.9);

    const res = await fetch("/predict_frame", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ image: dataUrl })
    });
    const json = await res.json();

    webcamOut.style.display = "block";
    if (!json.ok) {
      webcamOut.innerHTML = "<b>Webcam error:</b> " + (json.error || "unknown");
      return;
    }

    webcamOut.innerHTML =
      `<b>Webcam Result</b><br>` +
      `Faces: ${json.faces_detected} | Dominant: ${json.dominant} | Inference: ${json.elapsed_ms.toFixed(1)} ms`;

    webcamImg.innerHTML = `<img src="${json.annotated_url}" alt="Annotated webcam frame">`;

    webcamJson.style.display = "block";
    webcamJson.textContent = JSON.stringify(json.faces, null, 2);

    // refresh charts if already visible
    if (json.charts?.bar)  document.querySelector('img[alt="Bar chart"]')?.setAttribute("src", json.charts.bar);
    if (json.charts?.line) document.querySelector('img[alt="Line chart"]')?.setAttribute("src", json.charts.line);
    if (json.charts?.pie)  document.querySelector('img[alt="Pie chart"]')?.setAttribute("src", json.charts.pie);
  };

  // LLM
  const llmBtn = document.getElementById("llmBtn");
  const promptTxt = document.getElementById("promptTxt");
  const llmOut = document.getElementById("llmOut");

  llmBtn.onclick = async () => {
    llmOut.style.display = "block";
    llmOut.innerHTML = "<b>LLM:</b> Στέλνω...";

    const prompt = promptTxt.value.trim();
    const res = await fetch("/llm_generate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt })
    });
    const json = await res.json();

    if (!json.ok) {
      llmOut.innerHTML = "<b>LLM error:</b> " + (json.error || "unknown");
      return;
    }
    llmOut.innerHTML = "<b>LLM αποτέλεσμα:</b><br>" + json.text;
  };
</script>
</body>
</html>
